<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login - EDU-TECH LMS</title>
  <link rel="stylesheet" href="../css/main.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <style>
    /* Minimal inline styles for spinner used by this page (optional if your CSS already covers it) */
    .spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: rgba(255,255,255,0.9);
      border-radius: 50%;
      animation: spin .75s linear infinite;
      margin-right: .5rem;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg) } }
    /* small utilities just to ensure smooth alert transitions */
    .alert { transition: transform .25s ease, opacity .25s ease; }
  </style>
</head>
<body class="bg-background min-h-screen">
  <!-- Navigation Header -->
  <nav class="bg-surface shadow-soft sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- Logo -->
        <div class="flex items-center">
          <a href="../landing_page.html" class="flex items-center">
            <svg class="h-10 w-10 text-primary-600" viewBox="0 0 40 40" fill="currentColor" aria-hidden="true">
              <rect x="4" y="8" width="32" height="24" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
              <path d="M8 16h24M8 20h16M8 24h20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              <circle cx="30" cy="12" r="2" fill="currentColor"/>
            </svg>
            <span class="ml-3 text-xl font-heading font-semibold text-text-primary">EDU-TECH LMS</span>
          </a>
        </div>

        <!-- Navigation Links -->
        <div class="hidden md:flex items-center space-x-6">
          <a href="./landing_page.html" class="text-text-secondary hover:text-primary-600 transition-smooth">Home</a>
          <a href="./landing_page.html#features" class="text-text-secondary hover:text-primary-600 transition-smooth">Features</a>
          <a href="./landing_page.html#grades" class="text-text-secondary hover:text-primary-600 transition-smooth">Grades</a>
          <a href="./user_login.html" class="text-primary-600 font-medium">Login</a>
          <a href="./user_registration.html" class="btn-primary">Register</a>
        </div>

        <!-- Mobile Menu Button -->
        <div class="md:hidden">
          <button id="mobile-menu-btn" class="text-text-secondary hover:text-primary-600 p-2" title="Open menu" aria-expanded="false">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Mobile Menu -->
      <div id="mobile-menu" class="hidden md:hidden pb-4" aria-hidden="true">
        <div class="flex flex-col space-y-3">
          <a href="./landing_page.html" class="text-text-secondary hover:text-primary-600 px-2 py-1">Home</a>
          <a href="./landing_page.html#features" class="text-text-secondary hover:text-primary-600 px-2 py-1">Features</a>
          <a href="./landing_page.html#grades" class="text-text-secondary hover:text-primary-600 px-2 py-1">Grades</a>
          <a href="./user_login.html" class="text-primary-600 font-medium px-2 py-1">Login</a>
          <a href="./user_registration.html" class="btn-primary inline-block text-center mx-2">Register</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="flex-1 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
      <!-- Header Section -->
      <div class="text-center">
        <div class="mx-auto h-16 w-16 bg-primary-50 rounded-full flex items-center justify-center mb-6">
          <svg class="h-8 w-8 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
        </div>
        <h1 class="text-3xl font-heading font-bold text-text-primary mb-2">Welcome Back</h1>
        <p class="text-text-secondary">Sign in to your EDU-TECH LMS account</p>
      </div>

      <!-- Login Form -->
      <div class="bg-surface shadow-card rounded-2xl p-8">
        <form id="loginForm" class="space-y-6" novalidate>
          <!-- Email Field -->
          <div>
            <label for="email" class="block text-sm font-medium text-text-primary mb-2">Email Address</label>
            <div class="relative">
              <input type="email" id="email" name="email" required class="input-field w-full pl-10 pr-4 py-3 text-base" placeholder="Enter your email address" autocomplete="email" aria-describedby="email-error">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zM12 16v.01"/>
                </svg>
              </div>
            </div>
            <div id="email-error" class="hidden mt-1 text-sm text-error-light" role="alert">
              <svg class="inline h-4 w-4 mr-1" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6z" clip-rule="evenodd"/>
              </svg>
              Please enter a valid email address
            </div>
          </div>

          <!-- Password Field -->
          <div>
            <label for="password" class="block text-sm font-medium text-text-primary mb-2">Password</label>
            <div class="relative">
              <input type="password" id="password" name="password" required class="input-field w-full pl-10 pr-12 py-3 text-base" placeholder="Enter your password" autocomplete="current-password" aria-describedby="password-error">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/>
                </svg>
              </div>
              <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 pr-3 flex items-center text-text-secondary hover:text-primary-600 transition-smooth" title="Toggle password visibility" aria-pressed="false">
                <svg id="eyeOpen" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                <svg id="eyeClosed" class="h-5 w-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.878 9.878l4.242 4.242"/>
                </svg>
              </button>
            </div>
            <div id="password-error" class="hidden mt-1 text-sm text-error-light" role="alert">
              <svg class="inline h-4 w-4 mr-1" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0z" clip-rule="evenodd"/>
              </svg>
              Password is required
            </div>
          </div>

          <!-- Remember Me & Forgot Password -->
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-border rounded" aria-label="Remember me">
              <label for="remember-me" class="ml-2 block text-sm text-text-secondary">Remember me</label>
            </div>
            <div class="text-sm">
              <a href="javascript:void(0)" class="font-medium text-primary-600 hover:text-primary-500 transition-smooth">Forgot your password?</a>
            </div>
          </div>

          <!-- Login Button -->
          <div>
            <button type="submit" id="loginBtn" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-base font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-smooth" aria-live="polite">
              <span id="loginBtnText">Sign in</span>
              <div id="loginSpinner" class="hidden absolute inset-0 flex items-center justify-center" aria-hidden="true">
                <svg class="animate-spin h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
              </div>
            </button>
          </div>

          <!-- General Error Message -->
          <div id="general-error" class="hidden p-4 bg-error-light/10 border border-error-light/20 rounded-lg" role="alert" aria-live="assertive">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-error-light" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586z" clip-rule="evenodd"/>
                </svg>
              </div>
              <div class="ml-3">
                <p class="text-sm text-error-light" id="general-error-text">Invalid email or password. Please try again.</p>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Registration Link -->
      <div class="text-center">
        <p class="text-text-secondary">Don't have an account?
          <a href="user_registration.html" class="font-medium text-primary-600 hover:text-primary-500 transition-smooth">Create your account</a>
        </p>
      </div>

      <!-- Back to Home -->
      <div class="text-center">
        <a href="/landing_page.html" class="inline-flex items-center text-sm text-text-secondary hover:text-primary-600 transition-smooth" aria-label="Back to Home">
          <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          Back to Home
        </a>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-text-primary text-white py-8 mt-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="flex items-center mb-4 md:mb-0">
          <svg class="h-8 w-8 text-primary-500" viewBox="0 0 40 40" fill="currentColor" aria-hidden="true">
            <rect x="4" y="8" width="32" height="24" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
            <path d="M8 16h24M8 20h16M8 24h20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            <circle cx="30" cy="12" r="2" fill="currentColor"/>
          </svg>
          <span class="ml-3 text-lg font-heading font-semibold">EDU-TECH LMS</span>
        </div>
        <div class="flex space-x-6 text-sm">
          <a href="javascript:void(0)" class="text-secondary-400 hover:text-primary-500 transition-smooth">Privacy Policy</a>
          <a href="javascript:void(0)" class="text-secondary-400 hover:text-primary-500 transition-smooth">Terms of Service</a>
          <a href="javascript:void(0)" class="text-secondary-400 hover:text-primary-500 transition-smooth">Support</a>
        </div>
      </div>
      <div class="border-t border-secondary-600 mt-6 pt-6 text-center">
        <p class="text-secondary-400 text-sm">© 2025 EDU-TECH LMS. All Rights Reserved. | Designed for Sri Lankan Education System</p>
      </div>
    </div>
  </footer>

  <!-- ALERT CONTAINER (stacked toasts) -->
  <script>
    // Minimal alert stack used across the page
    const alertContainer = document.createElement('div');
    alertContainer.className = 'fixed top-4 right-4 z-50 flex flex-col gap-2';
    document.body.appendChild(alertContainer);

    function showAlert(message, type = 'info', duration = 5000) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} p-4 rounded-lg shadow-lg max-w-sm transform transition-all duration-300 ease-out opacity-0 translate-x-10`;
      alertDiv.setAttribute('role', 'status');
      alertDiv.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span>${type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ'}</span>
            <p class="text-sm">${message}</p>
          </div>
          <button class="text-gray-400 hover:text-gray-600" aria-label="Close alert">×</button>
        </div>
      `;

      if (type === 'success') alertDiv.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
      else if (type === 'error') alertDiv.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
      else alertDiv.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-200');

      alertContainer.appendChild(alertDiv);

      // slide-in
      requestAnimationFrame(() => {
        alertDiv.classList.remove('opacity-0', 'translate-x-10');
        alertDiv.classList.add('opacity-100', 'translate-x-0');
      });

      // close button
      alertDiv.querySelector('button').addEventListener('click', () => removeAlert(alertDiv));

      setTimeout(() => removeAlert(alertDiv), duration);
    }

    function removeAlert(el) {
      el.classList.add('opacity-0', 'translate-x-10');
      setTimeout(() => {
        if (el.parentElement) el.remove();
      }, 300);
    }
  </script>

  <!-- EMBEDDED APP JS (production-ready client-side helpers + login logic) -->
  <script>
    (function () {
      // === CONFIG ===
      const API_BASE_URL = (window.location.hostname === 'localhost') ? 'http://localhost:5000/api' : '/api';

      // === UTILITIES ===
      function safeParseSession(storageKey = 'edutech_session') {
        const raw = localStorage.getItem(storageKey) || sessionStorage.getItem(storageKey);
        if (!raw) return null;
        try {
          const s = JSON.parse(raw);
          // Sanity checks
          if (!s || typeof s !== 'object') return null;
          if (s.token === undefined || s.user === undefined) return null;
          // Guard against string "undefined" or "null"
          if (!s.token || s.token === 'undefined' || s.token === 'null') return null;
          return s;
        } catch (e) {
          // corrupted session -> clear both
          localStorage.removeItem(storageKey);
          sessionStorage.removeItem(storageKey);
          return null;
        }
      }

      function getToken() {
        // Primary method: check unified session object
        const session = safeParseSession();
        if (session && session.token) return session.token;
        // Fallback: some pages may rely on top-level 'token' key (legacy)
        const legacy = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (legacy && legacy !== 'undefined' && legacy !== 'null') return legacy;
        return null;
      }

      function saveSession(session, remember = true) {
        // session: { user, token, loginTime, rememberMe }
        try {
          const json = JSON.stringify(session);
          if (remember) {
            localStorage.setItem('edutech_session', json);
            // Also set top-level token for backward compatibility
            localStorage.setItem('token', session.token || '');
          } else {
            sessionStorage.setItem('edutech_session', json);
            sessionStorage.setItem('token', session.token || '');
          }
        } catch (e) {
          console.error('Failed saving session', e);
        }
      }

      function clearSession() {
        localStorage.removeItem('edutech_session');
        sessionStorage.removeItem('edutech_session');
        localStorage.removeItem('token');
        sessionStorage.removeItem('token');
      }

      // Simple email validator
      function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      // === API HELPER ===
      async function apiRequest(endpoint, options = {}) {
        const url = `${API_BASE_URL}${endpoint}`;
        const config = {
          headers: { ...(options.headers || {}) },
          ...options
        };

        // If body is not FormData and not undefined, stringify
        if (config.body && !(config.body instanceof FormData)) {
          config.body = typeof config.body === 'string' ? config.body : JSON.stringify(config.body);
          config.headers['Content-Type'] = 'application/json';
        }

        // Add Authorization if token available
        const token = getToken();
        if (token) config.headers['Authorization'] = `Bearer ${token}`;

        try {
          const res = await fetch(url, config);
          const text = await res.text();
          let data = null;
          try { data = text ? JSON.parse(text) : null; } catch(e) { data = text; }

          if (!res.ok) {
            // If 401, clear session to avoid redirect loops caused by stale tokens
            if (res.status === 401) {
              clearSession();
            }
            const msg = (data && data.error) ? data.error : `Request failed with status ${res.status}`;
            throw new Error(msg);
          }
          return data;
        } catch (err) {
          // bubble up after showAlert
          showAlert(err.message || 'Network error', 'error', 5000);
          throw err;
        }
      }

      // === AUTH FUNCTIONS ===
      async function login(email, password) {
        const body = { email, password };
        const result = await apiRequest('/login', { method: 'POST', body });
        if (!result || !result.token || !result.user) {
          throw new Error('Invalid login response from server');
        }
        // Build session object
        const session = {
          user: result.user,
          token: result.token,
          loginTime: new Date().toISOString()
        };
        // Remember by default if checkbox checked; calling code will pass remember flag into saveSession
        return session;
      }

      // Expose getToken and logout for other pages to use
      function logout() {
        clearSession();
        // Redirect to login page
        window.location.href = '/pages/user_login.html';
      }

      // === Public API on window.EDUApp ===
      window.EDUApp = {
        apiRequest,
        login,
        logout,
        getToken,
        saveSession,
        clearSession,
        validateEmail
        // other functions (getLessons, uploadFile, etc.) can be added here if needed
      };

      // === Page-specific wiring ===
      document.addEventListener('DOMContentLoaded', () => {
        // DOM elements
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const rememberMeCheckbox = document.getElementById('remember-me');
        const loginBtn = document.getElementById('loginBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const loginSpinner = document.getElementById('loginSpinner');
        const togglePasswordBtn = document.getElementById('togglePassword');
        const eyeOpen = document.getElementById('eyeOpen');
        const eyeClosed = document.getElementById('eyeClosed');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');

        // Mobile menu toggle
        if (mobileMenuBtn && mobileMenu) {
          mobileMenuBtn.addEventListener('click', function () {
            const isHidden = mobileMenu.classList.contains('hidden');
            mobileMenu.classList.toggle('hidden');
            mobileMenuBtn.setAttribute('aria-expanded', String(!isHidden));
          });
        }

        // Toggle password visibility
        if (togglePasswordBtn) {
          togglePasswordBtn.addEventListener('click', function () {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            eyeOpen.classList.toggle('hidden');
            eyeClosed.classList.toggle('hidden');
            togglePasswordBtn.setAttribute('aria-pressed', String(type === 'text'));
          });
        }

        function showFieldError(fieldId, message) {
          const errorEl = document.getElementById(`${fieldId}-error`);
          if (!errorEl) return;
          errorEl.innerHTML = message;
          errorEl.classList.remove('hidden');
        }

        function hideFieldError(fieldId) {
          const errorEl = document.getElementById(`${fieldId}-error`);
          if (!errorEl) return;
          // reset to default message if you want; here we'll hide
          errorEl.classList.add('hidden');
        }

        function setLoading(isLoading) {
          if (isLoading) {
            loginBtn.disabled = true;
            loginBtnText.classList.add('opacity-0');
            loginSpinner.classList.remove('hidden');
          } else {
            loginBtn.disabled = false;
            loginBtnText.classList.remove('opacity-0');
            loginSpinner.classList.add('hidden');
          }
        }

        // Real-time validation for email & password
        emailInput.addEventListener('input', function () {
          if (this.value && !validateEmail(this.value)) showFieldError('email', 'Please enter a valid email address');
          else hideFieldError('email');
        });

        passwordInput.addEventListener('input', function () {
          if (this.value && this.value.length > 0) hideFieldError('password');
        });

        // Prevent redirect flicker:
        // If the page was opened with redirected=true, we avoid redirecting immediately (used by other pages when session invalid)
        const urlParams = new URLSearchParams(window.location.search);
        const wasRedirected = urlParams.get('redirected') === 'true';

        // If there's an existing valid session, redirect to dashboard (but only if not explicitly redirected from dashboard)
        (function handleExistingSession() {
          const session = safeParseSession();
          if (session && session.token && !wasRedirected) {
            // We also set top-level token for pages that check localStorage.getItem('token')
            try { localStorage.setItem('token', session.token); } catch(e) {}
            // redirect based on role
            const role = (session.user && session.user.role) ? session.user.role : null;
            if (role === 'admin') window.location.href = '/pages/admin_dashboard.html';
            else if (role === 'teacher') window.location.href = '/pages/teacher_dashboard.html';
            else if (role === 'student') window.location.href = '/pages/student_dashboard.html';
            else window.location.href = '/pages/landing_page.html';
          }
        })();

        // Form submit
        loginForm.addEventListener('submit', async function (e) {
          e.preventDefault();
          // Clear errors
          hideFieldError('email');
          hideFieldError('password');
          document.getElementById('general-error').classList.add('hidden');

          const email = emailInput.value.trim();
          const password = passwordInput.value;
          let hasErrors = false;

          if (!email) {
            showFieldError('email', '<svg class="inline h-4 w-4 mr-1" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"/></svg>Email address is required');
            hasErrors = true;
          } else if (!validateEmail(email)) {
            showFieldError('email', 'Please enter a valid email address');
            hasErrors = true;
          }

          if (!password) {
            showFieldError('password', 'Password is required');
            hasErrors = true;
          }

          if (hasErrors) return;

          setLoading(true);
          try {
            const session = await login(email, password); // returns session object { user, token, loginTime }
            // Save session (remember checkbox)
            const remember = !!rememberMeCheckbox.checked;
            saveSession(session, remember);

            // Also ensure top-level token is set for any legacy checks
            try {
              if (remember) localStorage.setItem('token', session.token); else sessionStorage.setItem('token', session.token);
            } catch (e) { /* ignore storage errors */ }

            showAlert('Login successful! Redirecting...', 'success', 2500);
            // redirect after short delay based on role
            setTimeout(() => {
              const role = (session.user && session.user.role) ? session.user.role : null;
              if (role === 'admin') window.location.href = '/pages/admin_dashboard.html';
              else if (role === 'teacher') window.location.href = '/pages/teacher_dashboard.html';
              else if (role === 'student') window.location.href = '/pages/student_dashboard.html';
              else window.location.href = '/pages/landing_page.html';
            }, 900);
          } catch (err) {
            setLoading(false);
            document.getElementById('general-error-text').textContent = err.message || 'Invalid email or password. Please try again.';
            document.getElementById('general-error').classList.remove('hidden');
          }
        });

        // Demo autofill clicks (keeps your previous behavior)
        document.addEventListener('click', function (e) {
          const target = e.target;
          if (!target) return;
          // if user clicked a demo credential element (you used .bg-accent-50 previously)
          const demo = target.closest && target.closest('.bg-accent-50');
          if (demo) {
            const text = target.textContent || '';
            if (text.includes('student@edutech.lk')) {
              emailInput.value = 'student@edutech.lk';
              passwordInput.value = 'student123';
            } else if (text.includes('teacher@edutech.lk')) {
              emailInput.value = 'teacher@edutech.lk';
              passwordInput.value = 'teacher123';
            } else if (text.includes('admin@edutech.lk')) {
              emailInput.value = 'admin@edutech.lk';
              passwordInput.value = 'admin123';
            }
          }
        });
      }); // DOMContentLoaded end

    })();
  </script>

  <!-- If you have other site-wide JS, keep it; the page-level script above works independently.
       <script src="/public/app.js"></script>
       If you still include /public/app.js ensure it doesn't override window.EDUApp or token storage behavior. -->

</body>
</html>
